<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Рейтинг</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background:#f0f0f0; padding:20px; }
.container { max-width: 1200px; margin: 0 auto; }
.tabs { display:flex; gap:10px; margin-bottom:20px; }
.tab { padding:10px 20px; border-radius:6px; cursor:pointer; background:#fff8e1; border:1px solid #e6b800; font-weight:500; }
.tab.active { background:#ffc107; color:#fff; }
.filters { display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px; }
.search-input, select { padding:8px 12px; border-radius:6px; border:1px solid #e6b800; }
.search-input { flex:1; min-width:200px; }
.hidden { display:none; }
.rating-table { width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; margin-bottom:40px; }
.rating-table th, .rating-table td { padding:12px 16px; text-align:center; }
.rating-table thead { background:#ffc107; color:#fff; }
.rating-table tbody tr:nth-child(odd) { background:#fffdf4; }
.rating-table tbody tr:hover { background:#fff8e1; }
.position { font-weight:bold; color:#5c4500; }
.team-cell { display:flex; align-items:center; gap:10px; justify-content:left; }
.session-info { margin:20px 0; padding:15px; background:#fff8e1; border-left:4px solid #ffc107; border-radius:6px; }
</style>
</head>
<body>
<div class="container">
    <h1>Рейтинг</h1>
    <div class="tabs">
        <div class="tab active" id="tabTotal">Общий рейтинг</div>
        <div class="tab" id="tabSession">Рейтинг по сессии</div>
    </div>

    <div class="filters">
        <input type="text" id="teamSearch" class="search-input" placeholder="Поиск по талант ID...">
        <select id="sessionSelect" class="hidden"></select>
    </div>

    <div class="session-info hidden" id="sessionInfo">
        <h3></h3>
        <p>Дата проведения: 17.09.2025</p>
    </div>

    <div class="rating-container">
        <table class="rating-table" id="totalTable">
            <thead><tr><th class="position">Место</th><th>Талант ID</th></tr></thead>
            <tbody></tbody>
        </table>

        <table class="rating-table hidden" id="sessionTable">
            <thead><tr><th class="position">Место</th><th>Талант ID</th><th>Баллы</th><th>Решено задач</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
const tabTotal = document.getElementById('tabTotal');
const tabSession = document.getElementById('tabSession');
const totalTable = document.getElementById('totalTable').querySelector('tbody');
const sessionTable = document.getElementById('sessionTable').querySelector('tbody');
const sessionInfo = document.getElementById('sessionInfo');
const sessionSelect = document.getElementById('sessionSelect');
const teamSearch = document.getElementById('teamSearch');

let csvData = [];

// Загружаем CSV из той же директории
fetch('ratings.csv')
    .then(resp => resp.text())
    .then(data => {
        Papa.parse(data, {header:true, skipEmptyLines:true, complete: results => {
            csvData = results.data;
            initTables();
        }});
    });

function initTables(){
    const sessions = [...new Set(csvData.filter(r=>r.type=='session').map(r=>r.session))];
    sessionSelect.innerHTML = sessions.map(s=>`<option value="${s}">Сессия ${s}</option>`).join('');
    renderTotalTable();
    if(sessions.length) renderSessionTable(sessions[0]);
}

function renderTotalTable(){
    const totalTeams = {};
    csvData.filter(r=>r.type=='total').forEach(r=>{
        if(!totalTeams[r.team_id]) totalTeams[r.team_id] = {team_name:r.team_id, total:0};
        totalTeams[r.team_id].total += parseInt(r.score) || 0;
    });
    const sorted = Object.entries(totalTeams).sort((a,b)=>b[1].total - a[1].total);
    totalTable.innerHTML = '';
    sorted.forEach((entry,index)=>{
        const row = entry[1];
        totalTable.innerHTML += `<tr>
            <td class="position">${index+1}</td>
            <td class="team-cell">${row.team_name}</td>
        </tr>`;
    });
}

function renderSessionTable(session){
    const rows = csvData.filter(r=>r.type=='session' && r.session==session);
    rows.sort((a,b)=>parseInt(b.score)-parseInt(a.score));
    sessionTable.innerHTML = '';
    rows.forEach((r,index)=>{
        sessionTable.innerHTML += `<tr>
            <td class="position">${index+1}</td>
            <td class="team-cell">${r.team_id}</td>
            <td>${r.score}</td>
            <td>${r.tasks_solved}</td>
        </tr>`;
    });
    sessionInfo.querySelector('h3').textContent = `Сессия ${session}`;
}

// Вкладки
tabTotal.addEventListener('click', e=>{
    e.preventDefault();
    tabTotal.classList.add('active'); tabSession.classList.remove('active');
    document.getElementById('totalTable').classList.remove('hidden');
    document.getElementById('sessionTable').classList.add('hidden');
    sessionInfo.classList.add('hidden'); sessionSelect.classList.add('hidden');
});
tabSession.addEventListener('click', e=>{
    e.preventDefault();
    tabSession.classList.add('active'); tabTotal.classList.remove('active');
    document.getElementById('totalTable').classList.add('hidden');
    document.getElementById('sessionTable').classList.remove('hidden');
    sessionInfo.classList.remove('hidden'); sessionSelect.classList.remove('hidden');
});

// Поиск
teamSearch.addEventListener('keyup', function(){
    const filter = this.value.toLowerCase();
    const table = document.getElementById('totalTable').classList.contains('hidden') ? sessionTable.parentNode.querySelector('tbody') : totalTable;
    table.querySelectorAll('tr').forEach(tr=>{
        const team = tr.querySelector('.team-cell').textContent.toLowerCase();
        tr.style.display = team.includes(filter)?'':'none';
    });
});

// Смена сессии
sessionSelect.addEventListener('change', ()=>renderSessionTable(sessionSelect.value));
</script>
</body>
</html>
